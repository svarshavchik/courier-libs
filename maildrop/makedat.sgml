<!DOCTYPE refentry PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN" "http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">
<!-- Copyright 1998 - 2007 S. Varshavchik.  See COPYING for -->
<!-- distribution information. -->
<refentry id="makedat">
  <info><author><firstname>Sam</firstname><surname>Varshavchik</surname><contrib>Author</contrib></author><productname>Courier Mail Server</productname></info>

  <refmeta>
    <refentrytitle>makedat</refentrytitle>
    <manvolnum>1</manvolnum>
    <refmiscinfo class='manual'>S. Varshavchik.</refmiscinfo>
  </refmeta>

  <refnamediv>
    <refname>makedat</refname>
    <refpurpose>create GDBM/DB files for maildrop</refpurpose>
  </refnamediv>

  <refsynopsisdiv>
    <cmdsynopsis sepchar=" ">
      <command>makedat</command>
      <arg choice="req" rep="norepeat">-src=<replaceable>textfile</replaceable></arg>
      <arg choice="req" rep="norepeat">-tmp=<replaceable>tmpfile</replaceable></arg>
      <arg choice="req" rep="norepeat">-file=<replaceable>gdbmfile</replaceable></arg>
      <arg choice="opt" rep="norepeat">-cidr</arg>
      <arg choice="opt" rep="norepeat">-hup=<replaceable>hupfile</replaceable></arg>
    </cmdsynopsis>
  </refsynopsisdiv>

  <refsect1 id="makedat_description">
    <title>DESCRIPTION</title>

    <para>
The gdbm family of functions in <command>maildrop</command> provides access
to GDBM/DB databases - simple database files. The gdbm family of functions
provide a way of quickly storing and looking up key/data pairs.</para>

    <para>
You can use any program to create GDBM/DB database files.
<command>makedat</command> is a quick utility to create GDBM or DB files from
plain text files.</para>

    <para>
The system administrator selects whether <command>maildrop</command> uses
GDBM or DB
database files and whether <command>makedat</command> creates GDBM or DB
database files as well.</para>

    <para>
The <command>makedat</command> command may not be available to you. GDBM/DB
support in <command>maildrop</command> is optional, and the system
administrator may choose not to
install GDBM/DB support and the <command>makedat</command> command.</para>

    <para>
To see whether GDBM or DB support is being used, run the command
"<command>maildrop -v</command>".</para>

    <para>
The <replaceable>textfile</replaceable> argument to
<command>makedat</command> is a plain text file containing
key/value pairs. Each line in the text file contains a key value, followed by
a tab and a data value. The data value may be omitted, which
defaults to "1". For example, the following three lines:</para>

    <informalexample>
      <programlisting format="linespecific">
example.com

domain.com&lt;tab&gt;ok

foo.domain.com&lt;tab&gt;bad
</programlisting>
    </informalexample>

    <para>
Three key/value pairs are created: example.com, value "1"; domain.com,
value "ok", and "foo.domain.com", value "bad".</para>

    <para>
Empty lines in <replaceable>textfile</replaceable>, and lines starting with
the # character, are ignored.</para>

    <para>
<replaceable>textfile</replaceable> can be "-", in which case standard input
is used.</para>

    <para>
<replaceable>gdbmfile</replaceable> is the GDBM/DB file to create. If this
file exists, its existing contents are replaced.</para>

    <para>
<replaceable>tmpfile</replaceable> is a name of a temporary file in the same
directory as <replaceable>gdbmfile</replaceable>.
<replaceable>tmpfile</replaceable> is used by <command>makedat</command> to
create the GDBM
file, then <replaceable>tmpfile</replaceable> is renamed to
<replaceable>gdbmfile</replaceable>.</para>

    <para>
This approach foregoes any need for locking in order to be able to
dynamically update GDBM/DB files used by <command>maildrop</command>'s gdbm functions.
However, <command>makedat</command> does not use any locks on <replaceable>tmpfile</replaceable>, so multiple
instances of <command>makedat</command> using the same <replaceable>tmpfile</replaceable> are prohibited.</para>

    <para>
The <option>-cidr</option> flag specifies that the key is an IP netblock in
CIDR notation. This flag requires the <application>Net::CIDR</application>
Perl module to be installed separately. Download Net::CIDR from
<ulink url="http://www.cpan.org">http://www.cpan.org</ulink>.</para>

    <para>
      If the file named by the <option>-hup</option> parameter exists and
      contains a numerical PID, <command>makedat</command> reads the PID
      and sends a SIGHUP to that process.
    </para>
  </refsect1>

  <refsect1 id="makedat_subdir">
    <title>Reading subdirectories</title>

    <para>
      The <option>-src</option> parameter can specify a directory instead of
      a text file. This has the effect of concatenating all files in that
      directory (subject to the following checks) and then using the result
      as the <replaceable>textfile</replaceable>. The following checks are made:
    </para>

    <itemizedlist>
      <listitem>
	<para>
	  Files whose names contain a tilde, <quote>~</quote> are skipped over.
	</para>
      </listitem>

      <listitem>
	<para>
	  Files whose names end with the following suffixes result in an error
	  message: <quote>.rpmsave</quote>, <quote>.rpmnew</quote>, and
	  <quote>.dpkg-<replaceable>suffix</replaceable></quote>. These files
	  are backup files created by package manager when updating to a newer
	  version of the package and contain the old or the new version of a
	  configuration file whose settings may be new or obsolete.
	</para>
	<para>
	  The contents of the file whose name does not have the suffix should
	  be checked against the backup. The backup file should be deleted
	  after making any needed manual changes to the configuration file.
	</para>
      </listitem>

      <listitem>
	<para>
	  Files whose names end with the <quote>.dist</quote> suffix is also
	  treated as a configuration file backup or template, but with the
	  following exception: the <quote>.dist</quote> file gets ignored
	  and automatically skipped over, without any error message, if
	  the suffix-less file exists and its modification time is more recent
	  than the <quote>.dist</quote> file's modification time.
	</para>

	<para>
	  Otherwise an error message gets reported. Resolving the error
	  message is done by either copying the
	  <quote>.dist</quote> file or editing and saving the file without
	  the suffix (resulting in a newer timestamp).
	</para>
      </listitem>
    </itemizedlist>
  </refsect1>

  <refsect1 id="makedat_bugs">
    <title>BUGS</title>

    <para>
There are historical reasons why database functions in maildrop are called
gdbm functions. The initial implementation used GDBM functions exclusively.
The ability to use the DB library instead of the GDBM library has been added
later.</para>

  </refsect1>

  <refsect1 id="makedat_example">
    <title>EXAMPLE</title>
    <informalexample>
      <programlisting format="linespecific">
makedat blacklist /etc/mail/blacklist.tmp /etc/mail/blacklist.dat
</programlisting>
    </informalexample>

    <para>
Takes <filename>blacklist</filename>, and creates
<filename>/etc/mail/blacklist.dat</filename>, using
<filename>/etc/mail/blacklist.tmp</filename> as a temporary file.</para>

  </refsect1>
  <refsect1 id="makedat_see_also">
    <title>SEE ALSO</title>

    <para>
<ulink url="maildrop.html"><citerefentry><refentrytitle>maildrop</refentrytitle><manvolnum>1</manvolnum></citerefentry></ulink>,
<ulink url="maildropgdbm.html"><citerefentry><refentrytitle>maildropgdbm</refentrytitle><manvolnum>5</manvolnum></citerefentry></ulink>.</para>
  </refsect1>
</refentry>
