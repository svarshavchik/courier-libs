#!/bin/sh
#
# Copyright 1998 - 2025 Double Precision, Inc.  See COPYING for
# distribution information.

PWD=`pwd`

unset LC_CTYPE
unset LC_NUMERIC
unset LC_TIME
unset LC_COLLATE
unset LC_MONETARY
unset LC_MESSAGES
unset LC_PAPER
unset LC_NAME
unset LC_ADDRESS
unset LC_TELEPHONE
unset LC_MEASUREMENT
unset LC_IDENTIFICATION
unset LC_ALL
unset VERBOSE

if test "$VALGRIND" != ""
then
    VALGRIND="$VALGRIND --tool=memcheck --leak-check=full --error-exitcode=1"
fi

cat >testmailbot.1 <<EOF
From: =?iso-8859-1?Q?H=F3la!?= <test@example.com>
Return-Path: test2@example.com
Subject: Re: test message (fwd)
Mime-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1

Original
test
message
EOF

cat >testmailbot.msg <<EOF
Content-Type: text/plain; format=flowed; delsp=yes; charset=utf-8

autoreply text
EOF
LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -m testmailbot.msg cat <testmailbot.1

cat >testmailbot.1 <<EOF
From: =?iso-8859-1?Q?H=F3la!?= sender <test@xn--80ah.example.com>
To: toaddress@example.com
Cc: ccaddress@example.com
X-Newsgroup: alt.test
Newsgroups: alt.test.1,alt.test.2
Message-Id: <message1@example.com>
Errors-To: test2@example.com
Date: Sun, 22 Nov 2009 11:57:32 -0400
Subject: Re: test message, =?iso-8859-1?Q?H=F3la!?= (fwd)
Mime-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1

Original
test
message
EOF
LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -m testmailbot.msg cat <testmailbot.1
LANG=en_US.utf-8 TZ=EST5EDT $VALGRIND ./mailbot.tst -e -m testmailbot.msg \
    -S 'On %d,%nin %C (%N), %F (%f),%nin message %i, %s, writes:' \
    cat <testmailbot.1
LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T replyall -m testmailbot.msg cat <testmailbot.1
LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T replyall -N -m testmailbot.msg cat <testmailbot.1
LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T forward -F '+++ Forwarded Message +++' -m testmailbot.msg cat <testmailbot.1
LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T forwardatt -F '+++ Forwarded Message +++' -m testmailbot.msg cat <testmailbot.1 | sed 's/=_.*//'

cat >testmailbot.1 <<EOF
Mime-Version: 1.0
From: nobody@example.com
Content-Type: text/plain; charset=iso-8859-1
Content-Transfer-Encoding: quoted-printable

H=F3la!
EOF

cat >testmailbot.msg <<EOF
Content-Type: text/plain; format=flowed; delsp=yes; charset=utf-8

autoreply text
EOF

echo "===================="
LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T forward -F '+++ Forwarded Message +++' -m testmailbot.msg cat <testmailbot.1

echo "===================="
LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T forwardatt -F '+++ Forwarded Message +++' -m testmailbot.msg cat <testmailbot.1 | sed 's/=_.*//'

cat >testmailbot.1 <<EOF
Mime-Version: 1.0
From: nobody@example.com
Content-Type: multipart/alternative; boundary="zzz"

--zzz
Content-Type: text/plain; charset=iso-8859-1
Content-Transfer-Encoding: quoted-printable

H=F3la!

--zzz
Content-Type: text/html; charset=iso-8859-1
Content-Transfer-Encoding: quoted-printable

<h1>H=F3la!</h1>

--zzz--
EOF

echo "===================="
LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T forward -F '+++ Forwarded Message +++' -m testmailbot.msg cat <testmailbot.1

echo "===================="
LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T forwardatt -F '+++ Forwarded Message +++' -m testmailbot.msg cat <testmailbot.1 | sed 's/=_.*//'

cat >testmailbot.1 <<EOF
Mime-Version: 1.0
From: nobody@example.com
Content-Type: multipart/mixed; boundary="zzz"

--zzz
Content-Type: text/plain; charset=iso-8859-1
Content-Transfer-Encoding: quoted-printable

H=F3la!

--zzz
Content-Type: text/html; charset=iso-8859-1
Content-Transfer-Encoding: quoted-printable

<h1>Attachment h=F3la!</h1>

--zzz--
EOF

echo "===================="
LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T forward -F '+++ Forwarded Message +++' -m testmailbot.msg cat <testmailbot.1 | sed 's/=_.*//'

echo "===================="
LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T forwardatt -F '+++ Forwarded Message +++' -m testmailbot.msg cat <testmailbot.1 | sed 's/=_.*//'

cat >testmailbot.1 <<EOF
Mime-Version: 1.0
From: nobody@example.com
Subject: HTML message
Content-Type: text/html; charset=iso-8859-1
Content-Transfer-Encoding: quoted-printable

<h1>HTML message only</h1>
EOF

echo "===================="
LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T forward -F '+++ Forwarded Message +++' -m testmailbot.msg cat <testmailbot.1 | sed 's/=_.*//'

echo "===================="
LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T forwardatt -F '+++ Forwarded Message +++' -m testmailbot.msg cat <testmailbot.1 | sed 's/=_.*//'

cat >testmailbot.1 <<EOF
Mime-Version: 1.0
From: nobody@example.com
Subject: multipart/alternative with attachment
Content-Type: multipart/mixed; boundary=zzz

--zzz
Content-Type: multipart/alternative; boundary=yyy


--yyy
Content-Type: text/plain; charset=iso-8859-1

Text version of an HTML message

--yyy
Content-Type: text/html; charset=iso-8859-1
Content-Transfer-Encoding: quoted-printable

<h1>HTML message only</h1>

--yyy--

--zzz
Content-Type: text/plain

Text attachment

--zzz--
EOF

echo "===================="
LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T forward -F '+++ Forwarded Message +++' -m testmailbot.msg cat <testmailbot.1 | sed 's/=_.*//'

echo "===================="
LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T forwardatt -F '+++ Forwarded Message +++' -m testmailbot.msg cat <testmailbot.1 | sed 's/=_.*//'

echo "===================="

LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T reply -m testmailbot.msg cat <<EOF
From: nobody@example.com
Mime-Version: 1.0
Content-Type: text/plain; charset=utf-8

Message
> Quote level 1
>> Quote level 2
>
 space
EOF

LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T forward -F '+++ Forwarded Message +++' -m testmailbot.msg cat <<EOF
From: nobody@example.com
Mime-Version: 1.0
Content-Type: text/plain; charset=utf-8

Message
> Quote level 1
>> Quote level 2
>
 space
EOF

cat >testmailbot.1 <<EOF
From: test@example.com
Return-Path: test2@example.com
Subject: Test message
Mime-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1

Original
test
message
EOF

cat >testmailbot.msg <<EOF
Content-Type: text/plain; format=flowed; delsp=yes; charset=utf-8
Content-Transfer-Encoding: 8bit

DSN message text
EOF

LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -M nobody@example.com -N -m testmailbot.msg cat <testmailbot.1 | sed 's/=_.*//;s/Arrival-Date:.*/Arrival-Date:/'

LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T replyfeedback -R abuse -n -N -m testmailbot.msg \
    --feedback-source-ip 127.0.0.1 \
    --feedback-incidents 2 \
    <testmailbot.1 | sed 's/=_.*//;s/Arrival-Date:.*/Arrival-Date:/;s/User-Agent:.*//'

LANG=en_US.utf-8 $VALGRIND ./mailbot.tst -T feedback -R abuse -n -N -m testmailbot.msg \
    --feedback-source-ip 127.0.0.1 \
    --feedback-incidents 2 \
    <testmailbot.1 | sed 's/=_.*//;s/Arrival-Date:.*/Arrival-Date:/;s/User-Agent:.*//'

if test "@USE_GDBM@@USE_DB@" != "00" -a -x ../makedat/makedatprog
then
    cat >testmailbot.msg <<EOF
From: nobody@example.com
Subject: limited autoresponse

EOF
    echo "autoresponse" >testmailbot.msg2

    rm -f testmailbot.dat*

    $VALGRIND ./mailbot.tst -T reply -d testmailbot.dat -t testmailbot.msg2 \
	      cat <testmailbot.msg >testmailbot.out

    if grep -q -F 'autoresponse' testmailbot.out
    then
	:
    else
	echo "-d test failed (part 1)"
    fi

    $VALGRIND ./mailbot.tst -T reply -d testmailbot.dat -t testmailbot.msg2 \
	      cat <testmailbot.msg >testmailbot.out

    if grep -q -F 'autoresponse' testmailbot.out
    then
	echo "-d test failed (part 2)"
    fi

    $VALGRIND ./mailbot.tst -T reply -d testmailbot.dat -t testmailbot.msg2 \
	      -D 0 cat <testmailbot.msg >testmailbot.out

    if grep -q -F 'autoresponse' testmailbot.out
    then
	:
    else
	echo "-d test failed (part 3)"
    fi

    rm -f testmailbot.dat* testmailbot.out
fi

echo "Autoresponse test" >testmailbot.msg2

cat >testmailbot.msg <<EOF
From: sender@example.com
To: mail@example.com
Subject: Autoresponse successful

Autoresponse test 1
EOF

$VALGRIND ./mailbot.tst -T reply -r nobody@example.com,mail@example.com \
	  -t testmailbot.msg2 \
	  cat <testmailbot.msg

cat >testmailbot.msg <<EOF
From: nobody@example.com
To: something-else@example.com
Subject: Autoresponse failed

Autoresponse test 2 failed
EOF

$VALGRIND ./mailbot.tst -T reply -r nobody@example.com,mail@example.com \
	  -t testmailbot.msg2 \
	  cat <testmailbot.msg

cat >testmailbot.msg <<EOF
From: nobody@example.com
Cc: list@example.com,
  mail@example.com
Subject: Autoresponse successful

Autoresponse test 3
EOF

$VALGRIND ./mailbot.tst -T reply -r nobody@example.com,mail@example.com \
	  -t testmailbot.msg2 \
	  cat <testmailbot.msg
rm -f testmailbot.msg*
rm -f testmailbot.1
